<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="keywords" content="Simon, Coenen, Portfolio, Video, Game, Programmer, Graphics, Code, C++, DAE, Howest">

    <title>
        
            Natvis in Visual Studio
        
    </title>

    
        <meta name="description" content="Modifying watch window in Visual Studio using Natvis">
      

    <link rel="canonical" href="https://www.simoncoenen.com/blog/programming/Natvis">
    <link rel="alternate" type="application/rss+xml" href=" feed.xml" />
    
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Natvis in Visual Studio" />
<meta name="author" content="Simon Coenen" />
<meta property="og:locale" content="en_GB" />
<meta name="description" content="Modifying watch window in Visual Studio using Natvis" />
<meta property="og:description" content="Modifying watch window in Visual Studio using Natvis" />
<link rel="canonical" href="https://www.simoncoenen.com/blog/programming/Natvis" />
<meta property="og:url" content="https://www.simoncoenen.com/blog/programming/Natvis" />
<meta property="og:site_name" content="Simon Coenen" />
<meta property="og:image" content="https://www.simoncoenen.com/images/blog/003_natvis/Difference.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-13T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://www.simoncoenen.com/images/blog/003_natvis/Difference.png" />
<meta property="twitter:title" content="Natvis in Visual Studio" />
<meta name="twitter:site" content="@simon_coenen" />
<meta name="twitter:creator" content="@Simon Coenen" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Simon Coenen"},"dateModified":"2019-06-13T00:00:00+02:00","datePublished":"2019-06-13T00:00:00+02:00","description":"Modifying watch window in Visual Studio using Natvis","headline":"Natvis in Visual Studio","image":"https://www.simoncoenen.com/images/blog/003_natvis/Difference.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.simoncoenen.com/blog/programming/Natvis"},"url":"https://www.simoncoenen.com/blog/programming/Natvis"}</script>
<!-- End Jekyll SEO tag -->


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js" integrity="sha512-k2GFCTbp9rQU412BStrcD/rlwv1PYec9SNrkbQlo6RZCf75l6KcC3UwDY8H5n5hl4v77IDtIPwOk9Dqjs/mMBQ==" crossorigin="anonymous"></script>
    <script src="/js/main_head.js"></script>
    
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" integrity="sha512-ZKX+BvQihRJPA8CROKBhDNvoc2aDMOdAlcm7TUQY+35XYtrd3yh95QOOhsPDQY9QnKE0Wqag9y38OIgEvb88cA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link href="/css/main.css" rel="stylesheet">
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    
</head>
    <body>
        <!-- Navigation -->
<nav id="navbar" class="navbar sticky-top navbar-expand-lg navbar-dark">
    <a class="navbar-brand mb-0 h1" href="/">Simon Coenen<small>Graphics Programmer</small></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">

    <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            
                <li  class="nav-item" >
                    <a class="nav-link" href="/">Home</a>
                </li>
            
                <li  class="nav-item active" >
                    <a class="nav-link" href="/blog">Blog</a>
                </li>
            
                <li  class="nav-item" >
                    <a class="nav-link" href="/archive">Archive</a>
                </li>
            
                <li  class="nav-item" >
                    <a class="nav-link" href="/about">About</a>
                </li>
            
        </ul>
        <ul class="navbar-nav">
            
                <li class="nav-item">
                    
                        <a href="https://twitter.com/simon_coenen" target="_blank" class="nav-link">
                    
                        <span style="display:inline"><span style="display:inline; padding-right: 5px" class="fab fa-twitter fa-lg"></span></span>
                    </a>
                </li>
            
                <li class="nav-item">
                    
                        <a href="https://www.github.com/simco50" target="_blank" class="nav-link">
                    
                        <span style="display:inline"><span style="display:inline; padding-right: 5px" class="fab fa-github fa-lg"></span></span>
                    </a>
                </li>
            
                <li class="nav-item">
                    
                        <a href="https://www.linkedin.com/in/simon-coenen-906a58a3/" target="_blank" class="nav-link">
                    
                        <span style="display:inline"><span style="display:inline; padding-right: 5px" class="fab fa-linkedin fa-lg"></span></span>
                    </a>
                </li>
            
                <li class="nav-item">
                    
                        <a href="/downloads/SimonCoenen_Resume.pdf" target="_blank" class="nav-link">
                    
                        <span style="display:inline"><span style="display:inline; padding-right: 5px" class="fas fa-paperclip fa-lg"></span></span>
                    </a>
                </li>
            
            <li class="nav-item" style="padding-left: 10px; padding-top: 3px;">
                <div class="theme-switcher">
                    <input type="checkbox" id="theme-switch">
                    <span></span>
                </div>
            </li>
        </ul>
    </div>
</nav>


        <div class="page-content">
            
<div class="d-print-none">
    <img src="/images/blog/003_natvis/Difference.png" class="top-banner" style="height: 25em;"/>
    </figure>
    <div style="height:12vh"></div>
</div>


<div class="container project-container">
    <div class="row">
        <div class="col-print-12 col-md-9" id="markdown-content">
            <div class="blog-post">

<h1>Natvis in Visual Studio</h1>
<p style='font-style: italic;'>
    13 Jun 2019 - Simon Coenen - Reading time: <span class="reading-time" title="Estimated read time">
  
  
    4 mins
  
</span><span class="far fa-clock"></span> - <a href="#comment-section">Comments</a>
</p>

<p>When working on the C++ delegates (<a href="/blog/programming/CPP_Delegates">see previous post</a>), I found out about a thing called “natvis” and I never actually heard of it before even though it’s always been right under my nose when debugging Unreal Engine projects. It’s a really awesome and powerful debugging tool that allows you to define how classes should be visualized in the Visual Studio “Watch” windows and hover windows.</p>

<!--more-->

<p>So instead of having to dig through a load of expanders to find what you’re looking for in an object, you can fully customize the window to show only the relevant information of that object. Natvis is a xml-based file that you simply include in your Visual Studio project that <em>Just Works™</em>.</p>

<p>Many of you might already know about this but there’s a small detail that helps you with debugging natvis that you might not know about!</p>

<p><img src="/images/blog/003_natvis/Difference.png" alt="Difference" class="img-fluid" /></p>

<h2 id="setup">Setup</h2>

<p>It’s very easy to setup a natvis file, you create a new <code class="language-plaintext highlighter-rouge">.natvis</code> file with the following boilerplate code and include it in your project, the filename is not important. Visual Studio will automatically pick it up and you can have as many as you want.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;AutoVisualizer</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/vstudio/debugger/natvis/2010"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Content goes here --&gt;</span>
<span class="nt">&lt;/AutoVisualizer&gt;</span>
</code></pre></div></div>

<p>You can modify the natvis files while debugging and it will update automatically! When you make a mistake, visual studio will always fall back to the default view.</p>

<p>Debugging issues in natvis can be really annoying not knowing there’s an option for the output log to log errors and warnings during debugging. <strong>I highly recommend doing this</strong>! You can enable this in the Visual Studio options here.</p>

<p><img src="/images/blog/003_natvis/Options.png" alt="Options" class="img-fluid" /></p>

<h2 id="applying-to-delegates">Applying to delegates</h2>

<p>I found my delegates a good test case for natvis because it’s not always obvious when a delegate is bound and how it was allocated.</p>

<p>For the Delegates, implementing natvis is quite simple. To achieve the results in the image shown in the beginning, we have to change the way a <code class="language-plaintext highlighter-rouge">Delegate&lt;&gt;</code> and an <code class="language-plaintext highlighter-rouge">InlineAllocator&lt;&gt;</code> is visualized.</p>

<p>I wanted to easily know when a Delegate was bound or not and if the data of the function it it’s bound to, is allocated dynamically or inline. Interesting to note here, is that we can leverage the fact that MSVC sets uninitialized stack values to <code class="language-plaintext highlighter-rouge">0xcccccccc</code> that way we can distinguish uninitialized values from initialized values.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Type</span> <span class="na">Name=</span><span class="s">"Delegate&amp;lt;*&amp;gt;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;DisplayString</span> <span class="na">Condition=</span><span class="s">"m_Allocator.m_Size &amp;gt;= 0xcccccccc"</span><span class="nt">&gt;</span>Invalid<span class="nt">&lt;/DisplayString&gt;</span>
    <span class="nt">&lt;DisplayString</span> <span class="na">Condition=</span><span class="s">"m_Allocator.m_Size == 0"</span><span class="nt">&gt;</span>Unbound<span class="nt">&lt;/DisplayString&gt;</span>
    <span class="nt">&lt;DisplayString&gt;</span>Bound<span class="nt">&lt;/DisplayString&gt;</span>
<span class="nt">&lt;/Type&gt;</span>

<span class="nt">&lt;Type</span> <span class="na">Name=</span><span class="s">"InlineAllocator&amp;lt;*&amp;gt;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;DisplayString</span> <span class="na">Condition=</span><span class="s">"m_Size &amp;gt;= 0xcccccccc"</span><span class="nt">&gt;</span>Invalid<span class="nt">&lt;/DisplayString&gt;</span>
    <span class="nt">&lt;DisplayString</span> <span class="na">Condition=</span><span class="s">"m_Size == 0"</span><span class="nt">&gt;</span>Unallocated: {m_Size} bytes<span class="nt">&lt;/DisplayString&gt;</span>
    <span class="nt">&lt;DisplayString</span> <span class="na">Condition=</span><span class="s">"m_Size &amp;gt; $T1"</span><span class="nt">&gt;</span>Dynamic Memory: {m_Size} bytes<span class="nt">&lt;/DisplayString&gt;</span>
    <span class="nt">&lt;DisplayString</span> <span class="na">Condition=</span><span class="s">"m_Size &amp;lt;= $T1"</span><span class="nt">&gt;</span>Inline Memory: {m_Size} bytes<span class="nt">&lt;/DisplayString&gt;</span>
    <span class="nt">&lt;Expand&gt;</span>
        <span class="nt">&lt;Item</span> <span class="na">Name=</span><span class="s">"Data"</span> <span class="na">Condition=</span><span class="s">"m_Size &amp;gt; $T1"</span><span class="nt">&gt;</span>pPtr<span class="nt">&lt;/Item&gt;</span>
        <span class="nt">&lt;Item</span> <span class="na">Name=</span><span class="s">"Data"</span> <span class="na">Condition=</span><span class="s">"m_Size &amp;lt;= $T1"</span><span class="nt">&gt;</span>(void*)Buffer<span class="nt">&lt;/Item&gt;</span>
        <span class="nt">&lt;Item</span> <span class="na">Name=</span><span class="s">"Size"</span><span class="nt">&gt;</span>m_Size<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;/Expand&gt;</span>
<span class="nt">&lt;/Type&gt;</span>
</code></pre></div></div>

<p>In this case, I address all the instances of the <code class="language-plaintext highlighter-rouge">Delegate</code> class by using the wildcard <code class="language-plaintext highlighter-rouge">'*'</code> in <code class="language-plaintext highlighter-rouge">Delegate&amp;lt;*&amp;gt;</code> (notice we’re working in XML here and not use <code class="language-plaintext highlighter-rouge">'&lt;'</code> and <code class="language-plaintext highlighter-rouge">'&gt;'</code>, hence the <code class="language-plaintext highlighter-rouge">&amp;lt;</code> and <code class="language-plaintext highlighter-rouge">&amp;gt;</code>). This can be “specialized” using explicit types and/or values.</p>

<p>Addressing template values and types is done with the following syntax: <code class="language-plaintext highlighter-rouge">$T%idx%</code>. So in this case, I get the first template value (which is the max size of an inline allocation) using <code class="language-plaintext highlighter-rouge">$T1</code>. This also works for types if you want to do typecasting. Using the template value, we can figure out if the allocation is inline or dynamic.</p>

<p>I’ve extended this to work with the <code class="language-plaintext highlighter-rouge">MulticastDelegate</code> and what is cool is that because the <code class="language-plaintext highlighter-rouge">MulticastDelegate</code> is internally just a list of regular <code class="language-plaintext highlighter-rouge">Delegate</code>s, expanding the elements, will show each <code class="language-plaintext highlighter-rouge">Delegate</code> also using the visualization we’ve setup above. This is where things get a little bit more interesting. You can completely customize the way data is represented using <code class="language-plaintext highlighter-rouge">CustomListItems</code>. This allows you to even execute logic to get the data representation you want!</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Type</span> <span class="na">Name=</span><span class="s">"MulticastDelegate&amp;lt;*&amp;gt;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;DisplayString</span> <span class="na">Condition=</span><span class="s">"m_Locks == 0xcccccccc"</span><span class="nt">&gt;</span>Invalid<span class="nt">&lt;/DisplayString&gt;</span>
    <span class="nt">&lt;DisplayString</span> <span class="na">Condition=</span><span class="s">"m_Events.size() == 0"</span><span class="nt">&gt;</span>Unbound<span class="nt">&lt;/DisplayString&gt;</span>
    <span class="nt">&lt;DisplayString&gt;</span>Bound: {m_Events.size()}<span class="nt">&lt;/DisplayString&gt;</span>
    <span class="nt">&lt;Expand&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Name=</span><span class="s">"Locked"</span><span class="nt">&gt;</span>m_Locks <span class="ni">&amp;gt;</span> 0<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;CustomListItems</span> <span class="na">MaxItemsPerView=</span><span class="s">"100"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Variable</span> <span class="na">Name=</span><span class="s">"i"</span> <span class="na">InitialValue=</span><span class="s">"0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;Size&gt;</span>m_Events.size()<span class="nt">&lt;/Size&gt;</span>
    <span class="nt">&lt;Loop&gt;</span>
        <span class="nt">&lt;Item&gt;</span>m_Events[i].second.m_Allocator<span class="nt">&lt;/Item&gt;</span>
        <span class="nt">&lt;Exec&gt;</span>i++<span class="nt">&lt;/Exec&gt;</span>
    <span class="nt">&lt;/Loop&gt;</span>
    <span class="nt">&lt;/CustomListItems&gt;</span>
    <span class="nt">&lt;/Expand&gt;</span>
<span class="nt">&lt;/Type&gt;</span>
</code></pre></div></div>

<p>For every Delegate in the list, we’re actually only interested in the <code class="language-plaintext highlighter-rouge">InlineAllocator</code> because that shows us all the information I’m interested in.</p>

<p>Below the difference:</p>

<p><img src="/images/blog/003_natvis/MulticastVis.png" alt="MulticastVis" class="img-fluid" /></p>

<h2 id="more-information">More information</h2>

<p>You can do much more than the simple example shown above. For example, visualizing non-sequential memory is not straight forward, however there is some great functionality in the natvis framework that help you do this.
I highly recommend looking at the <a href="https://docs.microsoft.com/en-us/visualstudio/debugger/create-custom-views-of-native-objects?view=vs-2019#BKMK_Syntax_reference">syntax reference</a> for more info.</p>

<h2 id="links">Links</h2>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/visualstudio/debugger/create-custom-views-of-native-objects?view=vs-2019">Create custom views of C++ objects in the debugger</a></li>
  <li><a href="https://devblogs.microsoft.com/cppblog/debug-visualizers-in-visual-c-2015/">Debug Visualizers in Visual C++ 2015</a></li>
  <li><a href="https://davidhalonen.wordpress.com/2016/04/23/visual-studio-data-visualization-debugging-natvis/">Visual Studio Data Visualization: Debugging Natvis</a></li>
</ul>


</div>

<hr>

<div class="PageNavigation row d-print-none">
  <div class="text-left col-sm-6">
  
    <a class="btn btn-sm sharp" href="/blog/programming/CPP_Delegates">&laquo; Previous: C++ Delegates</a>
  
  </div>
  <div class="text-right col-sm-6">
  
    <a class="btn btn-sm sharp" href="/blog/programming/StaticReflection">Next: Basic compile-time type information using constexpr &raquo;</a>
  
  </div>
</div>


<div class="d-print-none" id="comment-section">
    <script src="https://utteranc.es/client.js"
        repo="simco50/simoncoenen.com"
        issue-term="title"
        label="utterances-comment"
        theme="github-dark"
        crossorigin="anonymous"
        async>
    </script>
</div>

        </div>

        <div class="col-md-3 d-print-none blog-sidebar">
            <ul class="social-buttons">
                <li>
                    <a href="/feed.xml">
                    <svg xmlns="http://www.w3.org/2000/svg" class="bi bi-rss" viewBox="0 0 16 16">
                            <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                            <path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z"/>
                        </svg>
                    </a>
                </li>
                
                <li>
                    <a onclick="javascript:window.print()" href="#">
                        <svg xmlns="http://www.w3.org/2000/svg"class="bi bi-printer" viewBox="0 0 16 16">
                            <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                            <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
                        </svg>
                    </a>
                </li>
                
            </ul>
            <nav class="sticky-top d-none d-md-block">
                
                <h3>Contents</h3>
                <div id="table-of-contents" class="table-of-contents">
                    <ul><li>Natvis in Visual Studio<ul><li><a href="#setup">Setup</a></li><li><a href="#applying-to-delegates">Applying to delegates</a></li><li><a href="#more-information">More information</a></li><li><a href="#links">Links</a></li></ul></li></ul>
                </div>
                

                <h3>Recent posts</h3>
                <div class="flex-column table-of-contents">
                <ul>
                    
                        <li class=""><a href="/blog/programming/graphics/DoomEternalStudy">DOOM Eternal - Graphics Study</a></li>
                    
                        <li class=""><a href="/blog/programming/graphics/DxcCompiling">Using the DirectXShaderCompiler C++ API</a></li>
                    
                        <li class=""><a href="/blog/programming/graphics/SpotlightCulling">Optimizing spotlight intersection in tiled/clustered light culling</a></li>
                    
                        <li class=""><a href="/blog/programming/PakFiles">Pak files - Virtual file system</a></li>
                    
                        <li class=""><a href="/blog/programming/StaticReflection">Basic compile-time type information using constexpr</a></li>
                    
                        <li class=""><a href="/blog/programming/Natvis">Natvis in Visual Studio</a></li>
                    
                    <li class=""><a href="/blog_index">More...</a></li>
                </ul>
                </div>
            </nav>
        </div>
    </div>
</div>
        </div>

        <!-- /.container -->
        <!--Footer-->
<footer>
    <script src="/js/main.js"></script>
</footer>
    </body>
</html>